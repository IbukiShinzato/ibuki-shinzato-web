<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="description" content="macOS で x86_64 アセンブリを書くための基本手順と注意点" />
  <title>Assembly 入門メモ</title>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Assembly 入門メモ</h1>
</header>
<h2 id="アセンブラのメモ">アセンブラのメモ</h2>
<p><a href="https://godbolt.org">アセンブラ変換サイト（Godbolt）</a></p>
<ul>
<li>スタックは下に伸びる</li>
<li><code>DWORD</code>（Double Word） = 32bit = 4バイト</li>
</ul>
<h2 id="実行方法macosの場合">実行方法（macOSの場合）</h2>
<pre class="bash"><code>nasm -f macho64 &lt;file.asm&gt; -o &lt;file.o&gt;
clang &lt;file.o&gt; -o &lt;executive_file&gt; -arch x86_64</code></pre>
<ul>
<li>$?は終了コード（プログラムがOSに返す数値、基本は0）</li>
<li>global命令で外部公開</li>
<li>global命令の際に_(アンダーバー)をつけないとリンカが見つけられないからmainも_mainとシンボル名にする</li>
<li>*Linuxの場合は<code>-f elf64</code>を使う</li>
</ul>
<h2 id="動作確認">動作確認</h2>
<pre class="bash"><code>./&lt;executive_file&gt;
echo $?</code></pre>
<p><code>$?</code> は直前のコマンドの終了コード（= 戻り値、通常は
<code>eax</code> の値）</p>
<h2 id="global命令とは">global命令とは？</h2>
<ul>
<li><code>global</code>
命令で関数やラベルを外部公開できる（リンカから参照可能にする）</li>
<li>macOS では C の <code>main</code> は <code>_main</code>
という名前で呼ばれるため、アセンブリでは <code>global _main</code>
のように書く必要がある。</li>
</ul>
<h2 id="clangでアセンブリ出力">clangでアセンブリ出力</h2>
<p>Cのコードをclangでアセンブリ出力してみる</p>
<h3 id="main.c">main.c</h3>
<pre class="c:main.c"><code>int add(int a, int b) {
    return a + b;
}

int main() {
    return add(5, 7);
}</code></pre>
<h3 id="アセンブリ出力">アセンブリ出力</h3>
<pre class="bash"><code>clang -S -O0 -arch x86_64 main.c -o main.s</code></pre>
<h3 id="main.s">main.s</h3>
<pre class="s:main.s"><code>    .section    __TEXT,__text,regular,pure_instructions
    .build_version macos, 15, 0 sdk_version 15, 5
    .globl  _add                            ## -- Begin function add
    .p2align    4, 0x90
_add:                                   ## @add
    .cfi_startproc
## %bb.0:
    pushq   %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset %rbp, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register %rbp
    movl    %edi, -4(%rbp)
    movl    %esi, -8(%rbp)
    movl    -4(%rbp), %eax
    addl    -8(%rbp), %eax
    popq    %rbp
    retq
    .cfi_endproc
                                        ## -- End function
    .globl  _main                           ## -- Begin function main
    .p2align    4, 0x90
_main:                                  ## @main
    .cfi_startproc
## %bb.0:
    pushq   %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset %rbp, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register %rbp
    subq    $16, %rsp
    movl    $0, -4(%rbp)
    movl    $5, %edi
    movl    $7, %esi
    callq   _add
    addq    $16, %rsp
    popq    %rbp
    retq
    .cfi_endproc
                                        ## -- End function
.subsections_via_symbols</code></pre>
<ul>
<li>-S アセンブリ出力</li>
<li>-O0 最適化オプション -O0は最適化なし</li>
<li>-arch アーキテクチャ指定</li>
</ul>
</body>
</html>
